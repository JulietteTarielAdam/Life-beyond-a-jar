---
title: "Code of the statistical analysis for the article 'Life Beyond A Jar: Effects of Tank Size and Enrichment on the Behaviour and Welfare of Siamese Fighting Fishes'"
date: "`r Sys.Date()`"
author: "Juliette Tariel-Adam"
format: 
   html:
    embed-resources: true
    self-contained-math: true
editor_options: 
  chunk_output_type: console
knitr:
  opts_chunk:
    fig-align: center
    out-width: "100%"
---

```{r}
#| include: false
# Run the scripts that load the data and that contains the functions to plot and do the linear models
source("Script/Load-data.R")
source("Script/Functions/Plots.R")
source("Script/Functions/Linear-model.R")
```

Jar/Small/Medium/Large are compared among each other, and Large/Barren between each other. Barren is not compared to Jar/Small/Medium because they differ by two factors: enrichment and size. 

On the html knitted output of this script, you fill find below a first row of tabs to click on (PCA, Swimming, etc) and for most of these tabs, a second row of tabs to click on (Distribution, Plot, etc).

::: {.panel-tabset}

# Data description

After staying 3-7 days in a tank, the behaviour of all fish were scored by four 10-min trials in this tank. All trials occurred the same day at 4 different times (7 am, 10 am, 2 pm, 6 pm). During the 10 min trial = 600 sec, the fish's behaviour was assigned to one of the 9 behaviours, meaning that the behaviours are mutually exclusive (a fish can't be scored as nest building and interacting with the surface at the same time): Resting, Swimming, Hovering, Sinking/Floating, Stereotypic swimming, Nest building, Foraging, Interation with surface, Out of view.

Out.of.view is a bit special because it is not a behaviour and was not analysed.

Sinking/Floating was not analysed (see explanation in the conclusion of the PCA section).

```{r}
summary(data)

# Number of observations per fish per tank
data %>% group_by(Fish, Tank) %>%
  summarise(n=n(), .groups = 'drop') %>%
  spread(Tank,n) 

# Number of observations per fish per time
data %>% group_by(Fish, Time) %>%
  summarise(n=n(), .groups = 'drop') %>%
  spread(Time,n) 

# Sum of all behaviours per trial
data$total <- rowSums(dplyr::select(data, Resting:Out.of.view)) 
sort(data$total) 
```

The sum of all behaviours should be 600 sec, it varies between `r min(data$total)` and `r max(data$total)`, but it is alright. 

The data has been inspected and corrected for data entry errors (sum of scored behaviours too low/high, column shifted, typos, inconsistent nb of observations per fish/time/tank...).

## Plots

The mean value over multiple trials is plotted to only have one value per treatment. 

```{r}
#| column: page
#| echo: false
#| warning: false
# the plot1 function is in the script "Plots.R"
plot1("Tank")

plot1("Tank","Fish") +  facet_wrap_paginate(~Fish,ncol=2,nrow=2, page = 1) + ggtitle("Per fish") 
plot1("Tank","Fish") +  facet_wrap_paginate(~Fish,ncol=2,nrow=2, page = 2) + ggtitle("Per fish")
plot1("Tank","Fish") +  facet_wrap_paginate(~Fish,ncol=2,nrow=2, page = 3) + ggtitle("Per fish")
plot1("Tank","Fish") +  facet_wrap_paginate(~Fish,ncol=2,nrow=2, page = 4) + ggtitle("Per fish")

plot1("Tank","Time") +  facet_wrap(~Time) + ggtitle("Per time")
```

## Table

## Filter

```{r}
# nb of observations per tank with or without filter
table(data$Tank, data$Filter)/4 
# nb of observations per fish with or without filter
table(data$Fish, data$Filter)/4 

plot1("Filter", "Tank") +  facet_wrap(~Tank)
```

Filter needs to be included in all models as a control variable.

## Order of trials

Fish underwent different order of treatments: Some fish started with Large, then Small, etc; Other fish with Medium, then Jar, etc. Is there an effect of the order of treatments? For instance, is there the same average swimming in Large whether Large was the 2nd or the 3rd treatments fish underwent? Visual investigation using the order of treatments.

```{r}
#| echo: false
# the plot_order function is in the script "Plots.R"
plot_order(data, "Swimming")
plot_order(data, "Resting")
data %>% mutate(Foraging.bin = as.numeric(Foraging.bin)-1) %>% 
plot_order(., "Foraging.bin")
data %>% mutate(SS.bin = as.numeric(SS.bin)-1) %>% 
plot_order(., "SS.bin")
data %>% mutate(Nest.bin = as.numeric(Nest.bin)-1) %>% 
plot_order(., "Nest.bin")
```

There was no consistent trend in the order of trials (for instance, fish did not perform more swimming at the 2nd trial whatever tank they were in).

# PCA

We run a PCA in order to:

+ Try to reduce the number of variables to analyse (even if we could analyse each behavioural type individually)
+ Determine which behavioural types are important to explain the variability between trials
+ See correlations between behavioural types

The PCA did not help reduce the number of variables to analyse (see Analysis_PCA.html for more explanation) so the behavioural types were analysed separately with linear models. This allows to interpret differences between tanks quantitatively compared to the PCA.

Even if we did not use PCA for further analysis, the first 3 components are plotted below, which explained 57% of variance in the data, to show the important variables and the correlations between variables. 

```{r}
(plotPCA1 <- plot(pca, choix = "var") + labs(title = NULL))
(plotPCA2 <- plot(pca, choix = "var", axes = c(1,3)) + labs(title = NULL))
```

```{r}
# Contribution to each principal component
round(pca$var$cos2,2)
# Extent to which each behavioural type contributes to the total variance explained by the first 3 components
rowSums(pca$var$contrib)/3
```

+ The 1st PCA component was driven by Resting (cos2 = 0.8), Swimming (0.7) and Foraging (0.3). Swimming and Foraging opposite to Resting. This first component could be interpret as "activity". If a fish spent a lot of time swimming and foraging during a trial, it was very little resting. This first component explained 25% of the variance in the data (as a reminder, the data is the time spent performing the different types of behaviour). So 1 quarter of the variance is a matter of activity. Keep in mind for the rest of the analyses that these behavioural types are correlated. 

+ The 2nd PCA component was driven by Hovering (cos2 = 0.5) and Stereotypic.swimming (0.5), and a bit by Interaction with surface (0.16). Hovering and Interacting.with.Surface opposite to Stereotypic.swimming. If the fish spent a lot of time hovering (and interacting with the surface), it was very little stereotypic swimming. This is interesting in my opinion.

+ The 3rd PCA component was driven mainly by Nest building (cos2 = 0.6), and a bit by Foraging (0.16), Resting (0.14) and Stereotypic Swimming (0.13). Foraging and Resting opposite to Nest building and Stereotypic Swimming. If a fish spent time foraging and resting in a trial, it was little nest building and stereotypic swimming. This makes sense, it a fish is building a nest,it is an important task and needs to be finished, so it is not scattering its time with other activities. The apparent correlation between nest building and stereotypic swimming could be due to Jar where fish in this tank rarely engaged in nest building or stereotypic swimming. 

Sinking/Floating contributed almost nothing to the first three components (2%) + did not correlate strongly with any of the component. Sinking/Floating was not important to explain the variability between trials. After discussion with Naomi and Culum, we agree to not analyse this behavioural type.

# Swimming

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Swimming)
```

## Plot 

The first plot is to see the trend by tank. Big red dots is for the overall mean  by tank. Small black points are raw data = resting time for each trial. 

The second plot is to see the trend by fish and by tank.The dashed black line is the overall means by tank. The other lines are the means for each fish by tank. 

```{r}
#| warning: false
(plotSwimming1 <- plot_var(data, "Swimming"))
(plotSwimming2 <- plot_var_fish(data, "Swimming"))
```

## Linear model 

```{r}
#| column: page
mSwimming <- lmer(Swimming ~ Tank + Time + Filter + (1|Fish), data = data)
lm_results(mSwimming)
calc_contrasts(mSwimming)
emmeans(mSwimming, ~ Time) # estimated means of time spent swimming depending on the time of the day 
```

Effect of Tank, Time and Filter! 

+ Tank. Large swam significantly more time than Jar, Small and Medium. Fish in fish in Large swan 93 sec [CI 45, 140] more than Jar (over a 600 sec trial), 79 sec [CI 32, 126] more than Small, and 81 sec [CI 39, 122] more than Medium. In addition,  fish in Large swam significantly more time (58 sec [CI 16, 101]) than fish in Barren. 
+ Time. Fish swim more in the morning than in the afternoon, especially at 7 am.
+ Filter. Fish swim more with a filter in their tank.

## Between-fish diff

```{r}
# first time if running the script
## rpt.swimming <- rpt(Swimming ~ Tank + Time + Filter + (1|Fish), grname = "Fish", data = data, datatype = "Gaussian", nboot = 1000, npermut = 1000)
## save(rpt.swimming, file = "Script/Repeatability rptR output/rpt.swimming")
base::load("Script/Repeatability rptR output/rpt.swimming")
summary(rpt.swimming)
```

The repeatability is quite low (0.2).


## Diagnosis

```{r}
lm_diagnosis(mSwimming)
```

The model seems good.

:::

# Resting

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Resting)
table(data$Resting==0)
```

Only 11 trials where the fish did not rest at all. 

## Plot 

```{r}
#| warning: false
(plotResting1 <- plot_var(data, "Resting"))
(plotResting2 <- plot_var_fish(data, "Resting"))
```

## Linear model 

```{r}
#| column: page
mResting <- lmer(Resting ~ Tank + Time + Filter + (1|Fish), data = data)
lm_results(mResting)
calc_contrasts(mResting)
emmeans(mResting, ~ Time)
```

Effect of Tank and Time.

+ Tank. Large rested significantly less time than Jar and Medium (almost significant for Small). Fish in Large rested 110 sec [CI 39, 181] more than fish in Jar (over a 600 sec trial), and 114 sec [CI 53, 175] more  fish in Medium. This is in line with the PCA and the results of Swimming: Fish that spent time swimming spent less time resting. Fish in Large were overall more active. No significant difference between Large and Barren. 
+ Time. Fish rest less time in the morning, especially at 7 am. In line with the PCA and the results of Swimming.

## Between-fish diff

```{r}
# first time if running the script
## rpt.resting <- rpt(Resting ~ Tank + Time + Filter + (1|Fish), grname = "Fish", data = data, datatype = "Gaussian", nboot = 1000, npermut = 1000)
## save(rpt.resting, file = "Script/Repeatability rptR output/rpt.resting")
base::load("Script/Repeatability rptR output/rpt.resting")
summary(rpt.resting)
```

The repeatability is OK 0.37

## Diagnosis

```{r}
lm_diagnosis(mResting)
```

The model seems good.

## Resting place

Just a plot with the amount of time resting at the different places depending on the tank. Each bar value is the mean of resting times over trials and fish. 

```{r}
#| column: page
#| echo: false
data_RP <- tf(master[master$Resting !=0 & !is.na(master$Resting),], 
            c("Tank","Resting.place","Fish","Filter","Time"), 
            c("Resting","Swimming"), # I have to specify two columns otherwise my function tf is not working
            function(x) colSums(x, na.rm = TRUE)) %>% 
  filter(Resting.place!= "N/A") %>% 
  mutate(Resting.place = fct_drop(Resting.place),
         Resting.place = factor(Resting.place, c("Floor","Surface","Surface against plant","Under or against plant","Plant leaves", "On or against barrel", "Inside barrel","Filter")))

palette_RP <- c("#E3C9B8", "#89D7F5", "#AEE3B9", "#84B05D","#84B05D", "#6B4921","#6B4921", "#B8B8B8")

(plotRP1 <- ggplot(data_RP, aes(y = Resting, x = Resting.place,fill = Resting.place)) +
  stat_summary(fun = mean,geom = "bar", size = 4)+
  geom_jitter(alpha = .5, width = 0.05, height=0, color = grey(0.25)) +
  scale_color_manual(values=palette_RP)+
  facet_wrap(~Tank)+
  guides(fill = FALSE)+
  scale_fill_manual(values = palette_RP)+
  ylab("Time spent resting (sec)")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1)))

(plotRP2 <- ggplot(data_RP, aes(y = Resting, x = Resting.place,fill = Resting.place)) +
  stat_summary(fun = mean,geom = "bar", size = 4)+
  geom_jitter(alpha = .5, width = 0.05, height=0, color = grey(0.25)) +
  scale_color_manual(values=palette_RP)+
  facet_wrap(~Fish)+
  guides(fill = FALSE)+
  scale_fill_manual(values = palette_RP)+
  ylab("Time spent resting (sec)")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1)))
```

From the graphs, we can see that fish use different places to rest, not only one type. They use all the different places available. It does not seem that there is a preferred resting place. 

:::

# Foraging

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Foraging)
table(data$Foraging==0)
descdist(data$Foraging, boot = 1000, print = FALSE)
```

The data are clearly not following a normal distribution. It seems that they could possibly follow a beta distribution but I thought beta distributions were when the variable is between 0 and 1. Foraging has thus been analysed as a binary variable: 1 if fish spent time foraging during this trial, 0 otherwise.

## Plot 

The plots are in count of trials. Green represents trials in which the fish foraged, gray in which the fish did not forage. 

```{r}
#| warning: false
(plotForaging1 <- plot_var_binary(data, "Foraging.bin"))
(plotForaging2 <- plot_var_binary_fish(data, "Foraging.bin"))
```

## Generalised linear model 

```{r}
#| column: page
mForaging <- glmmTMB(Foraging.bin ~ Tank + Time + Filter + (1|Fish), data = data, family =binomial)

Anova(mForaging)

calc_contrasts_bin(mForaging)
# example of differences between Jar and Large
## Contrast estimate
1/0.08
## Lower CI
1/0.437
## Upper CI
1/0.014
```

Effect of Tank. 

As a reminder, an odds.ratio < 1 between tank X vs tank Y means the probability of foraging during a trial in tank X is smaller that the probability of foraging during a trial in tank Y. An odd ratio for instance of 0.2 means that a fish is (1 / 0.2) = five times more likely to forage during a trial in tank Y than in Tank X. If we imagine 5 trials, fish will forage on average during 1 trial out of 5 in Tank X whereas fish will forage on average during 5 trials out of 5 in Tank Y. 

+ Tank. Fish were more likely to forage during a trial in Large compared to Jar, Small and Medium. Again in accordance with the PCA and the results of Swimming and Resting. Fish in Large were on average 13 times [CI 2, 71] more likely to forage during a trial than fish in Jar, 25 times [CI 4, 166] than fish in Small, and 4 times [CI 1, 13] than fish in Medium. In addition, fish were 15 times [CI 3, 63] more likely to forage during a trial in Large than Barren. In accordance with the PCA and the results of Swimming. This time, there was also a significant difference between small and medium.

## Between-fish diff

```{r}
# Attempt to calculate repeatability
rpt.foraging <- rpt(Foraging.bin ~ Tank + Time + Filter + (1|Fish), grname = "Fish", data = data, datatype = "Binary", nboot = 0, npermut = 0)

# Likelihood ratio test of random effect
mForaging0 <- glm(Foraging.bin ~ Tank + Time + Filter, data = data, family =binomial)
lrtest(mForaging0, mForaging)
```

Error when calculating the repeatability with rptR. Hard to estimate repeatability on binary data. I don't know how to do it without the package rptR. I think we don't have enough data power anyway to calculate repeatability with a binary variable.

Likelihood ratio test indicates a statistically significant random effect. Meaning that fish behaved differently among each others in terms of foraging. 

## Diagnosis 

```{r}
mForaging_res <- simulateResiduals(mForaging)
plot(mForaging_res)
plotResiduals(mForaging_res, form = data$Tank)
plotResiduals(mForaging_res, form = data$Time)
plotResiduals(mForaging_res, form = data$Filter)
```

The model seems good.

:::

# Stereotypic swimming

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Stereotypic.swimming)
table(data$Stereotypic.swimming==0)
descdist(data$Stereotypic.swimming, boot = 1000, print = FALSE)
```

Idem Foraging. Analysis as binary variable if the fish performs stereotypic swimming during a trial or not. 

## Plot 

```{r}
#| warning: false
(plotSS1 <- plot_var_binary(data, "SS.bin"))
(plotSS2 <- plot_var_binary_fish(data, "SS.bin"))
```

Huge variability between fish as always. Some fish never performed stereotypic swimming while some in all tanks. 

## Generalised linear model 

```{r}
#| column: page
mSS <- glmmTMB(SS.bin ~ Tank + Time + Filter + (1|Fish), data = data, family =binomial)

Anova(mSS)

calc_contrasts_bin(mSS)
```

Effect of Tank. 

+ Tank. Jar were less likely to perform stereotypic swimming during a trial than Small/Medium/Large but only significant between Jar and Small. Fish in Small were 33 times [CI 4, 333] more likely to perform stereotypic swimming during a trial than fish in Jar.

## Between-fish diff

```{r}
# Attempt to calculate repeatability
rpt.SS <- rpt(SS.bin ~ Tank + Time + Filter + (1|Fish), grname = "Fish", data = data, datatype = "Binary", nboot = 0, npermut = 0)

# Likelihood ratio test of random effect
mSS0 <- glm(SS.bin ~ Tank + Time + Filter, data = data, family =binomial)
lrtest(mSS0, mSS)
```

Error when calculating the repeatability with rptR. 

Likelihood ratio test indicates a statistically significant random effect. Meaning that fish behaved differently among each others in terms of stereotypic swimming. 

## Diagnosis

```{r}
mSS_res <- simulateResiduals(mSS)
plot(mSS_res)
plotResiduals(mSS_res, form = data$Tank)
plotResiduals(mSS_res, form = data$Time)
plotResiduals(mSS_res, form = data$Filter)
# Problem with Filter, I retried the model without Filter
mSS2 <- glmmTMB(SS.bin ~ Tank + Time + (1|Fish), data = data, family =binomial)
plot(simulateResiduals(mSS2))
```

It is expected to have a problem with filter as there are more than twice more trials without filter than with filter. No problem when removing Filter from the model. The model seems good.

## Stereotypic types

Just a plot with the type of stereotypic swimming depending on the tank. To stick with the analysis, it is a count (count = 1 if the fish performs a certain type of stereotypic swimming during a trial). 

```{r}
#| column: page
#| echo: false
data_SST <- tf(master[master$Stereotypic.swimming !=0 & !is.na(master$Stereotypic.swimming),], 
            c("Tank","Stereotypic.swimming.type","Fish","Filter","Time"), 
            c("Stereotypic.swimming","Swimming"), # I have to specify two columns otherwise my function tf is not working
            function(x) colSums(x, na.rm = TRUE))

ggplot(data_SST, aes(fill = Stereotypic.swimming.type2, x = Tank))+
    geom_bar(stat= "count",color=grey(0.4))+
    theme(legend.position="bottom")+
    ylab("Count of trials")

# Grouping type of stereotypic swimming together
data_SST$Stereotypic.swimming.type2 <- factor(data_SST$Stereotypic.swimming.type, 
                                              labels = c("Circles", "Pacing", "Pacing", "Pacing","Pacing", "Zig Zag"))
```

It seems that there are not differences between tanks. Just circles seem specific to larger tanks (Medium/Large/Barren).

I did not plot the place where the stereotypic swimming happens. Tell me if you need it. 


## Stereotypic Swimming repetitions

```{r}
#| column: page
#| echo: false
data_SST2 <- tf(master[master$Stereotypic.swimming !=0 & !is.na(master$Stereotypic.swimming),], 
            c("Tank","Stereotypic.swimming.type","Fish","Filter","Time"), 
            c("Stereotypic.swimming.number.of.repititions","Swimming"), # I have to specify two columns otherwise my function tf is not working
            function(x) colSums(x, na.rm = TRUE))

hist(data_SST2$Stereotypic.swimming.number.of.repititions)

data_SST2 %>%
  mutate(Nb.rep = Stereotypic.swimming.number.of.repititions) %>% 
  dplyr::select(Tank, Fish, Time, Stereotypic.swimming.type, Nb.rep) %>% 
  arrange(Fish, Tank, Time)
```

I don't think there are enough data to really say something about the number of repetitions. The number of repetitions seems pretty unique to a fish in a certain tank. I don't see ab obvious pattern depending on the tank. The interesting thing is that the stereotypic swimming seemed consistent in a tank for a fish (most or all trials of that day with stereotypic swimming). It is a pitty we couldn't calculate the repeatability of the binomial glm of Stereotypic Swimming because it would have been interesting. 

:::

# Hovering

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Hovering)
table(data$Hovering==0)
descdist(data$Hovering, boot = 1000, print = FALSE)
quantile(data$Hovering)
hist1(data$Hovering[data$Hovering!=0]) # histogram without the zeros
```

Even if there are less zeros than Foraging or Stereotypic Swimming, it is not a normal distribution. 

```{r}
ggplot(data, aes(x = log(Hovering + 1)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 5)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 10)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 15)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 20)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 25)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 30)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 50)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 70)))+
  geom_histogram(bins = 15, fill = grey(0.75), color="black")
ggplot(data, aes(x = log(Hovering + 103)))+
  geom_histogram(bins = 10, fill = grey(0.75), color="black")
```

XXXX OK to do log(x + 103)????

## Plot 

```{r}
#| warning: false
plot_var_binary(data, "Hovering.bin")
plot_var_binary(data, "Hovering.bin") + facet_wrap(~Fish)
```

## Generalised linear model 

```{r}
#| column: page
mHovering <- glmmTMB(Hovering.bin ~ Tank + Time + Filter + (1|Fish), data = data, family =binomial)

Anova(mHovering)

emmeans(mHovering, ~ Time, type = "response")
emmeans(mHovering, ~ Filter, type = "response")
```

No effect of Tank, only an effect of Time and filter

+ Time. Fish were less likely to hover in the afternoon.
+ Filter. Fish were less likely to hover with a filter in their tank.

## Diagnosis

```{r}
mHovering_res <- simulateResiduals(mHovering)
plot(mHovering_res)
```

The model seems good.

## Hovering place

Just a plot with where the fish hovers at the different places depending on the tank. To stick with the analysis, it is a count (count = 1 if the fish hovers in this place during a trial). 

```{r}
#| column: page
#| echo: false
data_HP <- tf(master[master$Hovering !=0 & !is.na(master$Hovering),], 
            c("Tank","Hovering.place","Fish","Filter","Time"), 
            c("Hovering","Swimming"), # I have to specify two columns otherwise my function tf is not working
            function(x) colSums(x, na.rm = TRUE)) %>% 
  mutate(Hovering.place = fct_drop(Hovering.place),
         Hovering.place = factor(Hovering.place, c("Above ground","Mid water column", "Just under surface", "Just under surface (under bubble nest)", "Inside barrel")))

palette_HP <- c("#E3C9B8", "#89D7F5", "#AEE3B9","#AEE3B9","#6B4921", "#B8B8B8")

ggplot(data_HP, aes(fill = Hovering.place, x = Tank))+
    geom_bar(stat= "count",color=grey(0.4))+
    scale_fill_manual(values = palette_HP)+
    ylab("Count of trials")

ggplot(data_HP, aes(fill = Hovering.place, x = Tank))+
    geom_bar(stat= "count",color=grey(0.4))+
    scale_fill_manual(values = palette_HP)+
    ylab("Count of trials")+
  facet_wrap("Fish")+
  theme(axis.text.x = element_text(angle=45,hjust=1),
        legend.position="bottom")
```

Fish used different places for hovering in all tanks.

:::

# Interaction with Surface

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Interation.with.surface)
table(data$Interation.with.surface==0)
```

Idem analysis binary generalised linear models.

## Plot 

```{r}
#| warning: false
(plotInteracting1 <- plot_var_binary(data, "Interacting.bin"))
(plotInteracting2 <- plot_var_binary_fish(data, "Interacting.bin"))
```

## Generalised linear model 

```{r}
#| column: page
mInteracting <- glmmTMB(Interacting.bin ~ Tank + Time + Filter + (1|Fish), data = data, family =binomial)

Anova(mInteracting)

calc_contrasts_bin(mInteracting)
```

Effect of Tank.

+ Tank. Fish were more likely to interact with the surface during a trial in Jar/Medium compared to Large (not significant for Small). Fish in Jar were 4 times [CI 1, 18] more likely to interact with the surface during a trial than fish in Large, and Fish in Medium were 6 times [CI 2, 23] then fish in Large. In addition, fish were 3 times [CI 1, 12] more likely to interact with a surface during a trial in Barren than in Large. 

## Diagnosis

```{r}
mInteracting_res <- simulateResiduals(mInteracting)
plot(mInteracting_res)
plotResiduals(mInteracting_res, form = data$Tank)
```

The model seems good.

## Interacting types

Just a plot with the type of interaction depending on the tank. To stick with the analysis, it is a count (count = 1 if the fish performs a certain type of interaction with surface during a trial). 

```{r}
#| column: page
#| echo: false
data_IT <- tf(master[master$Interation.with.surface !=0 & !is.na(master$Interation.with.surface),], 
            c("Tank","Interaction.with.surface.type","Fish","Filter","Time"), 
            c("Interation.with.surface","Swimming"), # I have to specify two columns otherwise my function tf is not working
            function(x) colSums(x, na.rm = TRUE))

ggplot(data_IT, aes(fill = Interaction.with.surface.type, x = Tank))+
    geom_bar(stat= "count",color=grey(0.4))+
    theme(legend.position="bottom")+
    ylab("Count of trials")
```

Idem, it would be nice to group together certain types of interaction to make it clearer.

:::

# Nest.building

::: {.panel-tabset}

## Distribution 

```{r}
hist1(data$Nest.building)
table(data$Nest.building==0)
```

There are 1 trial out of 5 where there was nest building. Analysis binary generalised model.

## Plot 

```{r}
#| warning: false
plot_var_binary(data, "Nest.bin")
plot_var_binary(data, "Nest.bin") + facet_wrap(~Fish)
```

## Generalised linear model 

```{r}
#| column: page
mNest <- glmmTMB(Nest.bin ~ Tank + Time + Filter + (1|Fish), data = data, family =binomial)

Anova(mNest)

calc_contrasts_bin(mNest)
emmeans(mNest, ~ Filter, type = "response")
```

Effect of Tank and Filter.
+ Tank. Despite a significant effect of Tank, no contrasts were statistically significant. This is usual when you have a weakly significant fixed effect of a factor (0.01 < p-value < 0.05) which has a lot of different levels. In terms of trend, fish in Jar seemed less likely to build a nest compared to Small/Medium/Large. In addition, fish in Barren were less likely to build nest than fish in Large. 
+ Filter. Fish were more likely to build a nest without a filter in their tank.

## Diagnosis

```{r}
mNest_res <- simulateResiduals(mNest)
plot(mNest_res)
plotResiduals(mNest_res, form = data$Tank)
plotResiduals(mNest_res, form = data$Time)
plotResiduals(mNest_res, form = data$Filter)
```

The model seems good.

:::

# Up and down 

Research question: did fish use differently use the upper part or lower part of their tank depending of the tank type?

```{r}
dataUpDown %>% 
ggplot(.,aes(y = perc.up, x = Tank)) +
  geom_jitter(alpha=.5, width=0.05)+
  stat_summary(fun = "mean", geom = "point", size = 4)+
  ylab("Percentage of time in the upper part of the tank")
```

It seems that the tank has an influence on whether fish prefer swimming on the upper half or lower half of the tank.

## Up and down 

```{r}
dataUpDown %>% filter(Resting!=0) %>% 
ggplot(.,aes(y = Resting, x = Tank, color = Up.Down)) +
  geom_jitter(alpha=.5, position = position_dodge(0.5))+
  stat_summary(fun = "mean", geom = "point", size = 4, position = position_dodge(0.5))
```

Irrespective of the tanks, the fish rested more time on the lower half of the tank than the upper half. This lower/upper difference in resting time was more or less pronounced depending on the tank.

# Figures for the paper
```{r}
(plotPCA1 <- plot(pca, choix = "var") + labs(title = NULL))
(plotPCA2 <- plot(pca, choix = "var", axes = c(1,3)) + labs(title = NULL))
(plotSwimming <- plot_var(data, "Swimming") + ylab("Time spent swimming (sec)"))

arrange <- ggarrange(plotPCA1, plotPCA2, labels =LETTERS[1:2])
ggsave(arrange, filename = "Plots/PCA.png", width = 10.3, height = 5.75)
```


plotRP1
plotRP2

# Conclusion

Here how I see the results section.

First, I would include the PCA to show the correlations between variables and to highlight the important variables that contribute to the most of variability in behaviour

Second, I would do a first big table for the results of the anova with the F-value, NumDf, DenDf and associated p-value for the fixed effects Tank, Filter and Time fixed effects. For the generalised mixed models (foraging, stereotypic swimming, etc), it is not the F-value but the Chisq, Df and p-value Foraging, Stereotypic Swimming, etc). For the linear models, I will also include in this big table the results for the random effect (Variance explained by fish, Residual variance and Repeatability). Then, I would put another table with the results of the contrasts between tanks with the contrast estimates, their confidence intervals, the associated t- or z-tests and p-values for readers to have an idea of the size of the difference between treatments. It is worth noting that the confidence intervals are large which is normal considering the number of fish.

Based on the two tables, what we can say first is that there is a effect of the Tank on all behaviours, the tank is there having a big influence on the betta's behaviour. Then, tt seems that we have three groups for the Jar/Small/Medium/Large

+ Jar with less likely to build a nest and less likely to perform stereotypic swimming compared to the others
+ Small and Medium
+ Large with more time swimming, less time resting, more likely to forage and less likely to interact with the surface

And Large and Barren are two different groups
+ Barren with less likely to build a nest
+ Large with more time swimming, more likely to forage and less likely to interact with the surface

Also, I would put something about the fact that each fish behave pretty uniquely. 

Tell me if you have any questions or would like to change something.  

The only thing I would like to do is to make sure the order in which fish have experienced the different tanks did not have any influence.

:::
